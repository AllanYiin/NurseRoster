<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>護理排班系統</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="brand__logo">NS</div>
        <div class="brand__text">
          <div class="brand__title">護理排班系統</div>
          <div class="brand__sub">v1 原型</div>
        </div>
      </div>

      <nav class="nav">
        <button class="nav__item is-active" data-view="calendar">
          <span class="nav__label">排班總覽</span>
        </button>
        <button class="nav__item" data-view="rules">
          <span class="nav__label">規則維護</span>
        </button>
        <button class="nav__item" data-view="bundles">
          <span class="nav__label">規則集精靈</span>
        </button>
        <button class="nav__item" data-view="master">
          <span class="nav__label">資料維護</span>
        </button>
        <button class="nav__item" data-view="opt">
          <span class="nav__label">最佳化</span>
        </button>
        <button class="nav__item" data-view="dsl">
          <span class="nav__label">DSL 測試台</span>
        </button>
      </nav>

      <div class="sidebar__footer">
        <div class="pill" id="projectPill">載入中…</div>
      </div>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="topbar__left">
          <h1 id="viewTitle">排班總覽</h1>
          <div class="muted" id="viewSub">週檢視（v1）</div>
        </div>
        <div class="topbar__right">
          <button class="btn btn--primary" id="btnCreateProject">建立專案</button>
          <button class="btn" id="btnRefresh">重新整理</button>
        </div>
      </header>

      <section class="content">
        <!-- Calendar -->
        <div class="view" id="view-calendar">
          <div class="card">
            <div class="card__hd">
              <div class="card__title">排班表</div>
              <div class="card__actions">
                <label class="field">
                  <span>起始日</span>
                  <input type="date" id="calStart" />
                </label>
                <label class="field">
                  <span>範圍</span>
                  <select id="calRange">
                    <option value="7">7 天</option>
                    <option value="28" selected>28 天</option>
                    <option value="month">月視圖</option>
                  </select>
                </label>
                <button class="btn btn--primary" id="btnLoadCalendar">載入</button>
              </div>
            </div>
            <div class="card__bd">
              <div class="calendar" id="calendarGrid"></div>
            </div>
            <div class="card__ft">
              <div class="muted">點選格子可編輯班別與備註。支援 7 天、28 天與整月視圖。</div>
            </div>
          </div>
        </div>

        <!-- Rules -->
        <div class="view is-hidden" id="view-rules">
          <div class="card" style="margin-top: 14px;">
            <div class="card__hd">
              <div class="card__title">規則對話介面（多輪 + 衝突檢視）</div>
              <div class="card__actions">
                <label class="field">
                  <span>衝突起</span>
                  <input type="date" id="conflictStart" />
                </label>
                <label class="field">
                  <span>衝突迄</span>
                  <input type="date" id="conflictEnd" />
                </label>
                <button class="btn" id="btnReloadConflicts">重新整理衝突</button>
              </div>
            </div>
            <div class="card__bd rulechat">
              <div class="rulechat__main">
                <div class="chatlog" id="ruleChatLog"></div>
                <div class="form" style="margin-top:12px;">
                  <label class="field full rulechat__input">
                    <span>對話輸入</span>
                    <textarea id="chatInput" rows="3" placeholder="描述想新增/調整的規則，系統會以串流方式回覆 DSL"></textarea>
                  </label>
                  <div class="row">
                    <button class="btn btn--primary" id="btnChatSend">送出並轉譯</button>
                    <button class="btn" id="btnChatApplyToDsl">帶到 DSL 測試台</button>
                  </div>
                  <div class="muted" id="chatStatus"></div>
                </div>
              </div>
              <div class="rulechat__side">
                <div class="subcard">
                  <div class="subcard__title">規則衝突總覽</div>
                  <div class="conflict-list" id="conflictList"></div>
                </div>
                <div class="subcard">
                  <div class="subcard__title">對話底稿 DSL</div>
                  <textarea id="ruleChatScratch" rows="8" placeholder="串流結果會放在這裡，可帶到測試台"></textarea>
                  <div class="row">
                    <button class="btn" id="btnScratchToTester">帶到 DSL 測試台</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card" style="margin-top: 14px;">
            <div class="card__hd">
              <div class="card__title">規則列表</div>
              <div class="card__actions">
                <label class="field">
                  <span>Scope</span>
                  <select id="ruleFilterScopeType">
                    <option value="">全部</option>
                    <option value="GLOBAL">GLOBAL</option>
                    <option value="HOSPITAL">HOSPITAL</option>
                    <option value="DEPARTMENT">DEPARTMENT</option>
                    <option value="NURSE">NURSE</option>
                  </select>
                </label>
                <label class="field">
                  <span>Scope ID</span>
                  <input type="number" id="ruleFilterScopeId" placeholder="全部" />
                </label>
                <label class="field">
                  <span>類型</span>
                  <select id="ruleFilterType">
                    <option value="">全部</option>
                    <option value="HARD">HARD</option>
                    <option value="SOFT">SOFT</option>
                    <option value="PREFERENCE">PREFERENCE</option>
                  </select>
                </label>
                <label class="field">
                  <span>關鍵字</span>
                  <input type="text" id="ruleFilterQ" placeholder="標題 / NL / DSL" />
                </label>
                <button class="btn" id="btnApplyRuleFilter">篩選</button>
                <button class="btn" id="btnClearRuleFilter">清除</button>
                <button class="btn" id="btnReloadRules">重新載入</button>
              </div>
            </div>
            <div class="card__bd">
              <table class="table" id="rulesTable">
                <thead>
                  <tr>
                    <th>標題</th>
                    <th>啟用</th>
                    <th>更新時間</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Rule Bundles Wizard -->
        <div class="view is-hidden" id="view-bundles">
          <div class="wizard">
            <aside class="wizard__steps">
              <div class="wizard__steps-title">步驟</div>
              <button class="wizard__step is-active" data-step="1">1．選擇排班期與科別</button>
              <button class="wizard__step" data-step="2">2．載入法規硬規則（LAW）</button>
              <button class="wizard__step" data-step="3">3．載入醫院硬規則（HOSPITAL）</button>
              <button class="wizard__step" data-step="4">4．選擇/編輯公版規則（TEMPLATE）</button>
              <button class="wizard__step" data-step="5">5．載入上一期個人偏好（NURSE_PREF）</button>
              <button class="wizard__step" data-step="6">6．預覽與驗證 → 生成 Bundle</button>
            </aside>
            <section class="wizard__content">
              <div class="wizard__panel is-active" data-step="1">
                <div class="wizard__panel-title">Step 1：選擇排班期與科別</div>
                <div class="muted">建立/載入本期 Schedule Period，並指定本期適用的規則集。</div>
                <div class="form-grid">
                  <label class="field">
                    <span>科別</span>
                    <select id="wizardDepartment"></select>
                  </label>
                  <label class="field">
                    <span>院區 ID（可選）</span>
                    <input type="number" id="wizardHospitalId" placeholder="例如：1" />
                  </label>
                  <label class="field">
                    <span>排班起日</span>
                    <input type="date" id="wizardStartDate" />
                  </label>
                  <label class="field">
                    <span>排班迄日</span>
                    <input type="date" id="wizardEndDate" />
                  </label>
                  <label class="field full">
                    <span>排班期名稱</span>
                    <input type="text" id="wizardPeriodName" placeholder="例如：ICU 2026-01 排班期" />
                  </label>
                </div>
                <div class="row">
                  <button class="btn btn--primary" id="wizardCreatePeriod">建立/載入排班期</button>
                  <div class="muted" id="wizardPeriodStatus">尚未建立排班期</div>
                </div>
              </div>
              <div class="wizard__panel" data-step="2">
                <div class="wizard__panel-title">Step 2：載入法規硬規則（LAW）</div>
                <div class="muted">GLOBAL + HARD + 啟用規則，預設全選。</div>
                <div class="wizard__list" id="wizardLawRules"></div>
              </div>
              <div class="wizard__panel" data-step="3">
                <div class="wizard__panel-title">Step 3：載入醫院硬規則（HOSPITAL）</div>
                <div class="muted">HOSPITAL + HARD + 啟用規則，預設全選。</div>
                <div class="wizard__list" id="wizardHospitalRules"></div>
              </div>
              <div class="wizard__panel" data-step="4">
                <div class="wizard__panel-title">Step 4：選擇/編輯公版規則（TEMPLATE）</div>
                <div class="row" style="flex-wrap: wrap;">
                  <label class="field">
                    <span>公版</span>
                    <select id="wizardTemplateSelect"></select>
                  </label>
                  <button class="btn" id="wizardTemplateReload">重新載入</button>
                  <button class="btn btn--primary" id="wizardTemplateCreate">新增公版</button>
                  <button class="btn" id="wizardTemplateEdit">編輯公版</button>
                  <button class="btn" id="wizardTemplateDelete">刪除公版</button>
                </div>
                <div class="muted">勾選要納入的規則（TEMPLATE 層）。</div>
                <div class="wizard__list" id="wizardTemplateRules"></div>
                <div class="row">
                  <button class="btn btn--primary" id="wizardTemplateSaveRules">儲存公版規則</button>
                  <div class="muted" id="wizardTemplateStatus">尚未載入公版</div>
                </div>
              </div>
              <div class="wizard__panel" data-step="5">
                <div class="wizard__panel-title">Step 5：載入上一期個人偏好（NURSE_PREF）</div>
                <div class="row" style="flex-wrap: wrap;">
                  <label class="field">
                    <span>偏好來源期別</span>
                    <select id="wizardNursePrefPeriod"></select>
                  </label>
                  <label class="field">
                    <span>載入模式</span>
                    <select id="wizardNursePrefMode">
                      <option value="CLONE_AS_IS" selected>CLONE_AS_IS</option>
                      <option value="CLONE_LATEST_VERSION">CLONE_LATEST_VERSION</option>
                    </select>
                  </label>
                </div>
                <div class="muted" id="wizardNursePrefStatus">尚未載入上一期</div>
              </div>
              <div class="wizard__panel" data-step="6">
                <div class="wizard__panel-title">Step 6：預覽與驗證</div>
                <div class="muted">生成後會固定版本（rule_version_id + hash），供本期最佳化與衝突解釋使用。</div>
                <div class="row">
                  <button class="btn" id="wizardValidateBundle">僅驗證</button>
                  <button class="btn btn--primary" id="wizardGenerateBundle">生成並套用</button>
                  <div class="pill" id="wizardValidationBadge">尚未驗證</div>
                </div>
                <div class="wizard__summary" id="wizardBundleSummary"></div>
                <div class="wizard__list" id="wizardBundlePreview"></div>
              </div>
              <div class="wizard__footer">
                <button class="btn" id="wizardPrev">上一步</button>
                <button class="btn btn--primary" id="wizardNext">下一步</button>
              </div>
            </section>
          </div>
        </div>

        <!-- Master -->
        <div class="view is-hidden" id="view-master">
          <div class="tabs">
            <button class="tab is-active" data-tab="nurses">護理師</button>
            <button class="tab" data-tab="departments">科別</button>
            <button class="tab" data-tab="shift">班別</button>
            <button class="tab" data-tab="levels">職級</button>
            <button class="tab" data-tab="skills">技能</button>
          </div>
          <div class="card">
            <div class="card__hd">
              <div class="card__title" id="masterTitle">護理師</div>
              <div class="card__actions">
                <button class="btn btn--primary" id="btnAddMaster">新增</button>
                <button class="btn" id="btnReloadMaster">重新載入</button>
              </div>
            </div>
            <div class="card__bd">
              <div id="masterTableWrap"></div>
            </div>
          </div>
        </div>

        <!-- Optimization -->
        <div class="view is-hidden" id="view-opt">
          <div class="grid2">
            <div class="card">
              <div class="card__hd">
                <div class="card__title">建立最佳化任務</div>
              </div>
              <div class="card__bd">
                <label class="field full">
                  <span>目標（可空，v1 mock）</span>
                  <textarea id="optGoal" rows="4" placeholder="例如：盡量平均夜班，滿足每日人力下限。"></textarea>
                </label>
                <button class="btn btn--primary" id="btnCreateJob">建立並執行（SSE）</button>
                <div class="muted" id="optStatus"></div>
                <div class="progress">
                  <div class="progress__bar" id="optBar" style="width:0%"></div>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card__hd">
                <div class="card__title">執行紀錄</div>
              </div>
              <div class="card__bd">
                <div class="log" id="optLog"></div>
              </div>
            </div>
          </div>
          <div class="card" style="margin-top:14px;">
            <div class="card__hd">
              <div class="card__title">Job 列表</div>
              <div class="card__actions">
                <button class="btn" id="btnReloadJobs">重新載入</button>
              </div>
            </div>
            <div class="card__bd">
              <table class="table" id="jobsTable">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>狀態</th>
                    <th>進度</th>
                    <th>更新時間</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- DSL Tester -->
        <div class="view is-hidden" id="view-dsl">
          <div class="card">
            <div class="card__hd">
              <div class="card__title">DSL 雙向測試台</div>
              <div class="card__actions">
                <button class="btn btn--primary" id="btnDslValidateOnly">僅驗證</button>
              </div>
            </div>
            <div class="card__bd dsl-lab">
              <div class="dsl-lab__col">
                <label class="field full">
                  <span>自然語言輸入（NL→DSL）</span>
                  <textarea id="dslLabNl" rows="6" placeholder="例如：外科白班每天至少 3 人，夜班不可連上 3 天"></textarea>
                </label>
                <button class="btn btn--primary" id="btnDslLabNlToDsl">轉成 DSL（SSE）</button>
                <div class="muted" id="dslLabNlStatus"></div>
              </div>
              <div class="dsl-lab__col">
                <label class="field full">
                  <span>DSL（JSON）</span>
                  <textarea id="dslTester" rows="12" placeholder="貼上 DSL（JSON）或由左側串流填入"></textarea>
                </label>
                <label class="field full">
                  <span>自訂 System Prompt（反向翻譯）</span>
                  <textarea id="dslPrompt" rows="4" placeholder="描述你希望的語氣與格式，留白則使用內建摘要"></textarea>
                </label>
                <div class="row">
                  <button class="btn" id="btnDslLabDslToNl">反向翻譯</button>
                  <button class="btn" id="btnDslLabValidate">驗證</button>
                </div>
                <div class="muted" id="dslTesterStatus"></div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- modal -->
  <div class="modal is-hidden" id="modal">
    <div class="modal__panel">
      <div class="modal__hd">
        <div class="modal__title" id="modalTitle">編輯</div>
        <button class="iconbtn" id="modalClose">×</button>
      </div>
      <div class="modal__bd" id="modalBody"></div>
      <div class="modal__ft">
        <button class="btn" id="modalCancel">取消</button>
        <button class="btn btn--primary" id="modalOk">確定</button>
      </div>
    </div>
  </div>

  <div id="toast" aria-live="polite"></div>

  <script type="module" src="/static/app.js"></script>
</body>
</html>
