name: Package Merge Artifact

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  bundle:
    name: Bundle repository after merge
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify required top-level files
        run: |
          for file in README.md requirements.txt project_launcher.py run_app.bat .env.example; do
            if [ ! -f "$file" ]; then
              echo "Missing required file: $file" >&2
              exit 1
            fi
          done

      - name: Prepare archive contents
        run: |
          ARCHIVE_ROOT="artifacts/nurse-roster-${GITHUB_SHA::7}"
          mkdir -p "$ARCHIVE_ROOT"
          echo "ARCHIVE_PATH=$ARCHIVE_ROOT" >> "$GITHUB_ENV"
          rsync -av --delete . "$ARCHIVE_ROOT" \
            --exclude ".git" \
            --exclude "artifacts" \
            --exclude "*.pyc" --exclude "*__pycache__*" \
            --exclude ".pytest_cache" \
            --exclude ".venv" --exclude "venv" \
            --exclude "dist" --exclude "build" \
            --exclude "node_modules"

          if [ -f "$ARCHIVE_ROOT/.env.example" ]; then
            cp "$ARCHIVE_ROOT/.env.example" "$ARCHIVE_ROOT/.env"
          else
            echo "Missing .env.example in archive root" >&2
            exit 1
          fi

      - name: Upload archive artifact
        uses: actions/upload-artifact@v4
        with:
          name: nurse-roster-merge-bundle-${{ github.sha }}
          path: ${{ env.ARCHIVE_PATH }}
          retention-days: 30
